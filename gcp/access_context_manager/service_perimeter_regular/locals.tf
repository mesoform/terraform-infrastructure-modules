locals {
  ingress_file      = fileexists(var.ingress_file_path) ? file(var.ingress_file_path) : null
  ingress_policies_read  = try(yamldecode(local.ingress_file), {})
  ingress_policies = {for index, policy in lookup(local.ingress_policies_read, "ingressPolicies", []): index => policy}

  egress_file      = fileexists(var.egress_file_path) ? file(var.egress_file_path) : null
  egress_policies_read  = try(yamldecode(local.egress_file), {})
  egress_policies = {for index, policy in lookup(local.egress_policies_read, "egressPolicies", [] ): index => policy}

  requested_restricted_services = var.restricted_services == null ? ["ALL-SERVICES"] : var.restricted_services
  restricted_services = contains(local.requested_restricted_services, "ALL-SERVICES") ? local.vpc_sc_supported_services : var.restricted_services
  // by default set VPC Accessible Services the same as restricted services for security
  vpc_accessible_services = var.vpc_accessible_services == null ? ["RESTRICTED-SERVICES"] : contains(var.vpc_accessible_services, "ALL-SERVICES") ? null : var.vpc_accessible_services
  vpc_accessible_services_enabled = contains(var.vpc_accessible_services, "ALL-SERVICES" ) ? false : true
  vpc_sc_supported_services = [
                                "accessapproval.googleapis.com",
                                "adsdatahub.googleapis.com",
                                "aiplatform.googleapis.com",
                                "alloydb.googleapis.com",
                                "analyticshub.googleapis.com",
                                "apigee.googleapis.com",
                                "apigeeconnect.googleapis.com",
                                "artifactregistry.googleapis.com",
                                "assuredworkloads.googleapis.com",
                                "automl.googleapis.com",
                                "backupdr.googleapis.com",
                                "baremetalsolution.googleapis.com",
                                "batch.googleapis.com",
                                "beyondcorp.googleapis.com",
                                "biglake.googleapis.com",
                                "bigquery.googleapis.com",
                                "bigquerydatapolicy.googleapis.com",
                                "bigquerydatatransfer.googleapis.com",
                                "bigquerymigration.googleapis.com",
                                "bigtable.googleapis.com",
                                "binaryauthorization.googleapis.com",
                                "blockchainnodeengine.googleapis.com",
                                "certificatemanager.googleapis.com",
                                "cloud.googleapis.com",
                                "cloudaicompanion.googleapis.com",
                                "cloudasset.googleapis.com",
                                "cloudbuild.googleapis.com",
                                "clouddeploy.googleapis.com",
                                "clouderrorreporting.googleapis.com",
                                "cloudfunctions.googleapis.com",
                                "cloudkms.googleapis.com",
                                "cloudprofiler.googleapis.com",
                                "cloudresourcemanager.googleapis.com",
                                "cloudscheduler.googleapis.com",
                                "cloudsearch.googleapis.com",
                                "cloudsupport.googleapis.com",
                                "cloudtasks.googleapis.com",
                                "cloudtrace.googleapis.com",
                                "composer.googleapis.com",
                                "compute.googleapis.com",
                                "confidentialcomputing.googleapis.com",
                                "config.googleapis.com",
                                "connectgateway.googleapis.com",
                                "connectors.googleapis.com",
                                "contactcenterinsights.googleapis.com",
                                "container.googleapis.com",
                                "containeranalysis.googleapis.com",
                                "containerfilesystem.googleapis.com",
                                "containerregistry.googleapis.com",
                                "containersecurity.googleapis.com",
                                "containerthreatdetection.googleapis.com",
                                "contentwarehouse.googleapis.com",
                                "datacatalog.googleapis.com",
                                "dataflow.googleapis.com",
                                "dataform.googleapis.com",
                                "datafusion.googleapis.com",
                                "datalineage.googleapis.com",
                                "datamigration.googleapis.com",
                                "datapipelines.googleapis.com",
                                "dataplex.googleapis.com",
                                "dataproc.googleapis.com",
                                "datastream.googleapis.com",
                                "dialogflow.googleapis.com",
                                "discoveryengine.googleapis.com",
                                "dlp.googleapis.com",
                                "dns.googleapis.com",
                                "documentai.googleapis.com",
                                "domains.googleapis.com",
                                "earthengine.googleapis.com",
                                "essentialcontacts.googleapis.com",
                                "eventarc.googleapis.com",
                                "file.googleapis.com",
                                "financialservices.googleapis.com",
                                "firebaseappcheck.googleapis.com",
                                "firebasecrashlytics.googleapis.com",
                                "firebaserules.googleapis.com",
                                "firestore.googleapis.com",
                                "gameservices.googleapis.com",
                                "gkebackup.googleapis.com",
                                "gkeconnect.googleapis.com",
                                "gkehub.googleapis.com",
                                "gkemulticloud.googleapis.com",
                                "gkeonprem.googleapis.com",
                                "healthcare.googleapis.com",
                                "iam.googleapis.com",
                                "iamcredentials.googleapis.com",
                                "iap.googleapis.com",
                                "iaptunnel.googleapis.com",
                                "identitytoolkit.googleapis.com",
                                "ids.googleapis.com",
                                "integrations.googleapis.com",
                                "kmsinventory.googleapis.com",
                                "krmapihosting.googleapis.com",
                                "language.googleapis.com",
                                "lifesciences.googleapis.com",
                                "livestream.googleapis.com",
                                "logging.googleapis.com",
                                "looker.googleapis.com",
                                "managedidentities.googleapis.com",
                                "memcache.googleapis.com",
                                "meshca.googleapis.com",
                                "meshconfig.googleapis.com",
                                "metastore.googleapis.com",
                                "microservices.googleapis.com",
                                "migrationcenter.googleapis.com",
                                "ml.googleapis.com",
                                "monitoring.googleapis.com",
                                "networkconnectivity.googleapis.com",
                                "networkmanagement.googleapis.com",
                                "networksecurity.googleapis.com",
                                "networkservices.googleapis.com",
                                "notebooks.googleapis.com",
                                "ondemandscanning.googleapis.com",
                                "opsconfigmonitoring.googleapis.com",
                                "orgpolicy.googleapis.com",
                                "osconfig.googleapis.com",
                                "oslogin.googleapis.com",
                                "policysimulator.googleapis.com",
                                "policytroubleshooter.googleapis.com",
                                "privateca.googleapis.com",
                                "publicca.googleapis.com",
                                "pubsub.googleapis.com",
                                "pubsublite.googleapis.com",
                                "rapidmigrationassessment.googleapis.com",
                                "recaptchaenterprise.googleapis.com",
                                "recommender.googleapis.com",
                                "redis.googleapis.com",
                                "retail.googleapis.com",
                                "run.googleapis.com",
                                "secretmanager.googleapis.com",
                                "securesourcemanager.googleapis.com",
                                "securetoken.googleapis.com",
                                "securitycenter.googleapis.com",
                                "servicecontrol.googleapis.com",
                                "servicedirectory.googleapis.com",
                                "servicehealth.googleapis.com",
                                "spanner.googleapis.com",
                                "speakerid.googleapis.com",
                                "speech.googleapis.com",
                                "sqladmin.googleapis.com",
                                "ssh-serialport.googleapis.com",
                                "storage.googleapis.com",
                                "storageinsights.googleapis.com",
                                "storagetransfer.googleapis.com",
                                "sts.googleapis.com",
                                "texttospeech.googleapis.com",
                                "timeseriesinsights.googleapis.com",
                                "tpu.googleapis.com",
                                "trafficdirector.googleapis.com",
                                "transcoder.googleapis.com",
                                "translate.googleapis.com",
                                "videointelligence.googleapis.com",
                                "videostitcher.googleapis.com",
                                "vision.googleapis.com",
                                "visionai.googleapis.com",
                                "visualinspection.googleapis.com",
                                "vmmigration.googleapis.com",
                                "vmwareengine.googleapis.com",
                                "vpcaccess.googleapis.com",
                                "webrisk.googleapis.com",
                                "websecurityscanner.googleapis.com",
                                "workflows.googleapis.com",
                                "workstations.googleapis.com"
                              ]
}
